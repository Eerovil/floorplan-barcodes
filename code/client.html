<!DOCTYPE html>
<html>
  <head>
    <title>Instascan</title>
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      html {
        height: 100%;
      }
      body {
        text-align: center;
        height: 100%;
      }
      .video {
        width: 100%;
        height: 20%;
      }
      .video canvas {
        height: 100%;
      }
      #iframe-wrapper {
        position: relative;
      }
      iframe {
        position: absolute;
        height: 80vh;
        width: 100%;
        top: 22rem;
        left: 0;
      }
      #wrapper {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="wrapper">
      <div id="iframe-wrapper">
        <iframe src="/"></iframe>
      </div>
      <video id="webcam_canvas" playsinline autoplay style="display:none"></video>
      <div class="video">
        <canvas id="out_canvas"></canvas>
      </div>

      <p style="display: none;">Camera Parameters (valid json, as given by <a href="https://www.calibdb.net/">calibdb</a>):<br/>
        <textarea id="camera_info" rows="10" cols="100">
          {
               "camera_matrix": [
                   [
                       939.3384407933022,
                       0,
                       640.347854307481
                   ],
                   [
                       0,
                       938.2560270381138,
                       340.7192620859387
                   ],
                   [
                       0,
                       0,
                       1
                   ]
               ],
               "img_size": [
                   1280,
                   720
               ]
           }
        </textarea>
       </p>

    </div>
    <script type="text/javascript">
      let context = null;

      const beep = (freq = 320, duration = 100, vol = 10) => {
          const oscillator = context.createOscillator();
          const gain = context.createGain();
          oscillator.connect(gain);
          oscillator.frequency.value = freq;
          oscillator.type = "square";
          gain.connect(context.destination);
          gain.gain.value = vol * 0.01;
          oscillator.start(context.currentTime);
          oscillator.stop(context.currentTime + duration * 0.001);
      }
      const speak = (text) => {
        const utter = new SpeechSynthesisUtterance();
        utter.lang = 'fi-FI';
        utter.text = text;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }
      if (window.speechSynthesis) {
        speechSynthesis.getVoices();
      }
      let lastDetId = null

      window.handleDetected = (det) => {
        const content = `http://koodi-${det.id + 1}`
        if (content == lastDetId) {
          return
        }
        lastDetId = content
        setTimeout(() => {
          lastDetId = null
        }, 1000)

        context = new AudioContext();
        beep();
        axios.post('/api/mark', {barcode: content}).then(function (response) {
          console.log(response);
          if (window.speechSynthesis) {
            speak(response.data);
          }
        }).catch(function (error) {
          console.log(error);
        });
        console.log(content);
      }

    </script>
    <script type="text/javascript" src="/static/apriltag/main.js"></script>
    <script type="module" async src="/static/apriltag/video_process.js"></script>
  </body>
</html>

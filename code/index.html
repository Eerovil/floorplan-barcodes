<html>
<head>
    <title>Vue.js</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/fireworks-js@latest/dist/fireworks.js"></script>

    <style>
        .point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
        #monster {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: blue;
            border-radius: 50%;
        }
        img {
            height: 100%;
        }
        #svg-el {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #wrapper {
            display: flex;
        }
        .fireworks-example {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #00000085;
        }
    </style>
</head>
<body>
    <div id="vue-app">
    </div>
    <script type="template/html" id="template">
        <div id="wrapper">
            <img ref="img" src="/static/floorplan.jpg"></img>
            <svg ref="svg" id="svg-el"></svg>
            <div
                v-for="point in points"
                :id="`point-${cleanCode(point.barcode)}`"
                class="point"
                :style="{'top': yToPx(point.y), 'left': xToPx(point.x), 'width': `${pointSize}px`, 'height': `${pointSize}px`}"
                @mousedown="dragStart($event, point)"
                :title="point.barcode"
            ></div>
            <div ref="monster" id="monster"></div>
            <div>
                <div v-for="kill in monster.kills">Napattu! {{ '{{ (new Date(kill.time)).toLocaleString("fi") }}' }}</div>
            </div>
            <div ref="fireworks" class="fireworks-example"></div>
        </div>
    </script>
    <script>
        var app = new Vue({
            el: '#vue-app',
            template: "#template",
            data: () => ({
                points: [],
                players: {},
                monster: {},
                dragTarget: null,
                pointSize: 25,
                monsterWidth: 40,
                monsterHeight: 40,

                fireworks: null,
            }),
            mounted() {
                this.fireworksInit();
                this.fetchTick();
            },
            methods: {
                xToPx(x, offset) {
                    return `${(x * this.imgEl.width) + (offset || 0)}px`;
                },
                yToPx(y, offset) {
                    return `${(y * this.imgEl.height) + (offset || 0)}px`;
                },
                drawLine(barcode1, barcode2) {
                    const el1 = document.querySelector(`#point-${this.cleanCode(barcode1)}`);
                    const el2 = document.querySelector(`#point-${this.cleanCode(barcode2)}`);
                    const b1 = el1.getBoundingClientRect();
                    const b2 = el2.getBoundingClientRect();
                    const newLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    newLine.setAttribute('id', 'line1');
                    newLine.setAttribute('x1', b1.left + b1.width / 2);
                    newLine.setAttribute('y1', b1.top + b1.height / 2);
                    newLine.setAttribute('x2', b2.left + b2.width / 2);
                    newLine.setAttribute('y2', b2.top + b2.height / 2);
                    newLine.setAttribute('style', 'stroke: black; stroke-width: 2;');
                    this.$refs.svg.append(newLine);
                },
                handleMonster(newMonster) {
                    const monsterEl = this.$refs.monster;
                    if (newMonster.status == "dead") {
                        this.showFireworks();
                        monsterEl.style.display = "none";
                    } else if (newMonster.status != this.monster.status || newMonster.location != this.monster.location) {
                        this.hideFireworks();
                        const newLocation = this.points[newMonster.location];
                        const newTarget = this.points[newMonster.target];
                        monsterEl.style.display = "block";
                        monsterEl.style.transition = ''
                        monsterEl.style.top = this.yToPx(newLocation.y, (this.pointSize / 2) - (this.monsterHeight / 2));
                        monsterEl.style.left = this.xToPx(newLocation.x, (this.pointSize / 2)-(this.monsterWidth / 2));
                        monsterEl.style.transition = `all ${newMonster.secs_to_location}s linear`
                        monsterEl.style.top = this.yToPx(newTarget.y, (this.pointSize / 2)-(this.monsterHeight / 2));
                        monsterEl.style.left = this.xToPx(newTarget.x, (this.pointSize / 2)-(this.monsterWidth / 2));
                    }
                    this.monster = newMonster;
                    this.monster.start_time = new Date(this.monster.start_time || null);
                    this.monster.target_time = new Date(this.monster.target_time || null);
                    this.monster.respawn = new Date(this.monster.respawn || null);
                },
                fetchTick() {
                    axios.get('/api/tick')
                        .then(response => {
                            console.log(response.data);
                            this.players = response.data.players;
                            this.points = response.data.codes;
                            this.handleMonster(response.data.monster);
                            console.log(this.monster.target, this.monster.target_time)
                            setTimeout(this.fetchTick
                            , 500);
                        })
                        .catch(error => {
                            console.log(error);
                        });
                },
                cleanCode(code) {
                    return code.replaceAll('/', '').replaceAll(':', '');
                },
                dragStart(event, point) {
                    this.dragTarget = point;
                    document.onmouseup = this.dragEnd;
                    document.onmousemove = this.updateDragTarget;
                },
                dragEnd() {
                    const target = this.dragTarget;
                    this.dragTarget = null;
                    document.onmouseup = null;
                    document.onmousemove = null;
                    axios.post('/api/modify', {barcode: target.barcode, x: target.x, y: target.y})
                        .then(response => {
                            console.log(response.data);
                            this.fetchPoints();
                        })
                        .catch(error => {
                            console.log(error);
                        });
                },
                updateDragTarget(event) {
                    event = event || window.event;
                    event.preventDefault();
                    // calculate the new cursor position:
                    this.dragTarget.x = (event.clientX - this.pointSize / 2) / this.imgEl.width;
                    this.dragTarget.y = (event.clientY - this.pointSize / 2) / this.imgEl.height;
                    console.log(this.dragTarget)
                },
                fireworksInit() {
                    const container = document.querySelector('.fireworks-example');
                    this.fireworks = new Fireworks(container, {
                        rocketsPoint: 50,
                        hue: { min: 0, max: 360 },
                        delay: { min: 15, max: 30 },
                        speed: 2,
                        acceleration: 1.05,
                        friction: 0.95,
                        gravity: 1.5,
                        particles: 90,
                        trace: 3,
                        explosion: 6,
                        autoresize: true,
                        brightness: { 
                            min: 50, 
                            max: 80,
                            decay: { min: 0.015, max: 0.03 }
                        },
                        mouse: { 
                            click: false, 
                            move: false, 
                            max: 3 
                        },
                        boundaries: { 
                            x: 50, 
                            y: 50, 
                            width: container.clientWidth, 
                            height: container.clientHeight 
                        },
                    });
                },
                showFireworks() {
                    this.$refs.fireworks.style.display = "block";
                    this.fireworks.start();
                },
                hideFireworks() {
                    this.$refs.fireworks.style.display = "none";
                    this.fireworks.stop();

                },
            },
            computed: {
                imgEl() {
                    return this.$refs.img;
                }
            }
        });
    </script>
</body>
</html>

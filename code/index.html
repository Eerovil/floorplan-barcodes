<html>
<head>
    <title>Vue.js</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
        img {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="vue-app">
    </div>
    <script type="template/html" id="template">
        <div>
            <img ref="img" src="/static/floorplan.jpg"></img>
            <div
                v-for="point in points"
                class="point"
                :style="{'top': point.y * imgEl.height, 'left': point.x * imgEl.width, 'width': `${pointSize}px`, 'height': `${pointSize}px`}"
                @mousedown="dragStart($event, point)"
                :title="point.barcode"
            ></div>
        </div>
    </script>
    <script>
        var app = new Vue({
            el: '#vue-app',
            template: "#template",
            data: () => ({
                points: [],
                dragTarget: null,
                pointSize: 25,
            }),
            mounted() {
                this.fetchPoints();
            },
            methods: {
                fetchPoints() {
                    axios.get('/api/list')
                        .then(response => {
                            console.log(response.data);
                            this.points = response.data;
                        })
                        .catch(error => {
                            console.log(error);
                        });
                },
                dragStart(event, point) {
                    this.dragTarget = point;
                    document.onmouseup = this.dragEnd;
                    document.onmousemove = this.updateDragTarget;
                },
                dragEnd() {
                    const target = this.dragTarget;
                    this.dragTarget = null;
                    document.onmouseup = null;
                    document.onmousemove = null;
                    axios.post('/api/modify', {barcode: target.barcode, x: target.x, y: target.y})
                        .then(response => {
                            console.log(response.data);
                            this.fetchPoints();
                        })
                        .catch(error => {
                            console.log(error);
                        });
                },
                updateDragTarget(event) {
                    event = event || window.event;
                    event.preventDefault();
                    // calculate the new cursor position:
                    this.dragTarget.x = (event.clientX - this.pointSize / 2) / this.imgEl.width;
                    this.dragTarget.y = (event.clientY - this.pointSize / 2) / this.imgEl.height;
                    console.log(this.dragTarget)
                }
            },
            computed: {
                imgEl() {
                    return this.$refs.img;
                }
            }
        });
    </script>
</body>
</html>

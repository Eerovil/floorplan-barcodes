<!DOCTYPE html>
<html>
  <head>
    <title>Instascan</title>
    <script type="text/javascript" src="/static/instascan.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      html {
        height: 100%;
      }
      body {
        text-align: center;
        height: 100%;
      }
      video {
        width: 100%;
        height: 20%;
      }
      #iframe-wrapper {
        position: relative;
      }
      iframe {
        position: absolute;
        height: 80vh;
        width: 100%;
        top: 0;
        left: 0;
      }
      #wrapper {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="wrapper">
      <div id="iframe-wrapper">
        <iframe src="/"></iframe>
      </div>
      <video id="preview"></video>
    </div>
    <script type="text/javascript">
      let context = null;

      const beep = (freq = 320, duration = 100, vol = 10) => {
          const oscillator = context.createOscillator();
          const gain = context.createGain();
          oscillator.connect(gain);
          oscillator.frequency.value = freq;
          oscillator.type = "square";
          gain.connect(context.destination);
          gain.gain.value = vol * 0.01;
          oscillator.start(context.currentTime);
          oscillator.stop(context.currentTime + duration * 0.001);
      }
      const speak = (text) => {
        const utter = new SpeechSynthesisUtterance();
        utter.lang = 'fi-FI';
        utter.text = text;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }
      if (window.speechSynthesis) {
        speechSynthesis.getVoices();
      }

      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      scanner.addListener('scan', function (content) {
        context = new AudioContext();
        beep();
        axios.post('/api/mark', {barcode: content}).then(function (response) {
          console.log(response);
          if (window.speechSynthesis) {
            speak(response.data);
          }
        }).catch(function (error) {
          console.log(error);
        });
        console.log(content);
      });
      Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
          scanner.start(cameras[0]);
        } else {
          console.error('No cameras found.');
        }
      }).catch(function (e) {
        console.error(e);
      });
    </script>
  </body>
</html>
